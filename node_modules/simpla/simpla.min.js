!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Simpla=e()}(this,function(){"use strict";function t(t){return window.btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode("0x"+e)}))}function e(t){switch(l.call(t)){case"[object String]":case"[object Number]":case"[object Boolean]":case"[object Null]":case"[object Undefined]":return!0}return!1}function n(t,r){var o;return l.call(t)===l.call(r)&&(e(t)?t===r:Array.isArray(t)?t.length===r.length&&t.every(function(t){return function(e,r){return n(e,t[r])}}(r)):(o=Object.keys(t)).length===Object.keys(r).length&&o.every(function(t,e){return function(r){return r in t&&r in e&&n(t[r],e[r])}}(t,r)))}function r(t){if(e(t))return t;if(Array.isArray(t))return t.map(r);var n=Object.create(null);for(var o in t)n[o]=r(t[o]);return n}function o(){return Math.random().toString(32).slice(-5)}function i(t){if(0!==t.indexOf("/"))throw new Error("Invalid path '"+t+"'. Path must start with leading '/'")}function s(t){if(null!==t){var e=["data","type","path","createdAt","updatedAt"],n=Object.keys(t);if("data"in t&&("object"!=typeof t.data||null===t.data))throw new TypeError("'data' property in item must be a non-null object. Got "+typeof t.data);if("type"in t&&"string"!=typeof t.type&&null!==t.type)throw new TypeError("'type' property in item must be a string or null. Got "+typeof t.type);for(var r=0,o=n.length;r<o;r++){var i=n[r];if(-1===e.indexOf(i))throw new Error("Invalid property "+i+". Valid properties are "+e.slice(0,-1).join(", ")+" or "+e[e.length-1]+".")}}}function a(t){var e,n=[],r=function(t,e,r){var i=o()+"."+e,s="[upload "+i+"]";return n.push([i,r]),s};return e=c(t,function(t){return"string"==typeof t?t.replace(/data:image\/(.+?);base64,([A-Za-z0-9+/=]+)/g,r):t}),[e,n]}function u(t){return function(e){var n=e[0];return!t||!t[n]||t[n].modified}}function c(t,e){if(Array.isArray(t))return t.map(function(t){return c(t,e)});if("object"==typeof t&&null!==t){var n=Object.create(null);for(var r in t)n[r]=c(t[r],e);return n}return e(t)}function h(){}var f="function"==typeof fetch?fetch.bind():function(t,e){return e=e||{},new Promise(function(n,r){function o(){var t,e=[],n=[],r={};return i.getAllResponseHeaders().replace(/^(.*?):\s*([\s\S]*?)$/gm,function(o,i,s){e.push(i=i.toLowerCase()),n.push([i,s]),t=r[i],r[i]=t?t+","+s:s}),{ok:1==(i.status/200|0),status:i.status,statusText:i.statusText,url:i.responseURL,clone:o,text:function(){return Promise.resolve(i.responseText)},json:function(){return Promise.resolve(i.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([i.response]))},headers:{keys:function(){return e},entries:function(){return n},get:function(t){return r[t.toLowerCase()]},has:function(t){return t.toLowerCase()in r}}}}var i=new XMLHttpRequest;i.open(e.method||"get",t);for(var s in e.headers)i.setRequestHeader(s,e.headers[s]);i.withCredentials="include"==e.credentials,i.onload=function(){n(o())},i.onerror=r,i.send(e.body)})},p=arguments,l=Object.prototype.toString,d=Object.assign?Object.assign.bind(Object):function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),n=1;n<p.length;n++){var r=p[n];if(null!=r)for(var o in r)r.hasOwnProperty(o)&&(e[o]=r[o])}return e},v=/\[upload\s(.+?)\]/g,b=function(t){var e=t.data,n=t.uploads,r=t.cacheBusting;this.contentUrl=e,this.uploadsUrl=n,this.cacheBusting=r};b.prototype.get=function(t){var e=this,n=function(t){return"string"==typeof t?t.replace(v,e.uploadsUrl+"/$1"):t},r=""+this.contentUrl+t+".json";return this.cacheBusting&&(r+="?time="+Date.now()),f(r).then(function(t){return 404===t.status?null:t.json()}).then(function(t){return c(t,n)})};var _=function(t){var e=t.repo,n=t.data;void 0===n&&(n="data");var r=t.uploads;void 0===r&&(r="uploads");var o=t.branch;void 0===o&&(o="master");var i=t.credentials;void 0===i&&(i=null),this.repo=e,this.branch=o,this.paths={data:n,uploads:r},this.credentials=i};_.prototype._request=function(t,e){void 0===e&&(e={});var n=e.method;void 0===n&&(n="GET");var r=e.body,o="https://api.github.com/repos/"+this.repo+"/"+t,i={Authorization:"token "+this.credentials.token};return r=r&&JSON.stringify(r),this.credentials.token?f(o,{method:n,body:r,headers:i}).then(function(t){return 204===t.status?null:t.json().then(function(e){if(!t.ok&&404!==t.status)throw e;return e})}):Promise.reject(new Error('Could not make request to GitHub, invalid token "'+this.credentials.token+'"'))},_.prototype._enqueue=function(t){return this._waitFor?this._waitFor=this._waitFor.then(t):this._waitFor=Promise.resolve().then(t),this._waitFor},_.prototype.all=function(){var t=this,e=this.paths.data.split("/"),n=e.pop(),r=e.join("/"),o=function(e){var r=e.find(function(t){return t.name===n});if(!r)throw new Error('Could not find folder "'+t.paths.data+'"');return t._request("git/trees/"+r.sha+"?recursive=1")},i=function(t){return t.tree.filter(function(t){return"blob"===t.type}).map(function(t){return"/"+t.path.replace(".json","")})};return this._enqueue(function(){return t._request("contents"+r+"?ref="+t.branch).then(o).then(i)})},_.prototype.startTransaction=function(){var t=this,e=new g({repo:this.repo,from:this.branch,credentials:this.credentials,branch:"simpla-editing-"+o(),data:this.paths.data,uploads:this.paths.uploads});return function(e){return t._request("branches/"+e).then(function(t){return t.commit.sha})}(this.branch).then(function(n){return t._request("git/refs",{method:"POST",body:{ref:"refs/heads/"+e.branch,sha:n}})}).then(function(){return e})},_.prototype.set=function(e,n){var r=this,o=a(n),i=o[0],s=o[1],u=function(t){return r._request("contents"+t+"?ref="+r.branch)},c=[""+this.paths.data+e+".json",t(JSON.stringify(i,null,2))],h=s.map(function(t){var e=t[0],n=t[1];return[r.paths.uploads+"/"+e,n]}).concat([c]),f=function(t,e){return function(n){var o=n.sha;return r._request("contents"+t,{method:"PUT",body:{message:"Updating "+t,branch:r.branch,path:t.slice(1),content:e,sha:o}})}};return Promise.all(h.map(function(t){var e=t[0],n=t[1];return r._enqueue(function(){return u(e).then(f(e,n))})})).then(function(){return n})},_.prototype.remove=function(t){var e=this,n=""+this.paths.data+t+".json",r=function(t){return e._request("contents"+t+"?ref="+e.branch)},o=function(r){var o=r.sha;return e._request("contents"+n,{method:"DELETE",body:{message:"Removing "+t,branch:e.branch,path:n.slice(1),sha:o}})};return this._enqueue(function(){return r(n).then(o).then(function(){return null})})};var g=function(t){function e(e){t.call(this,e),this.from=e.from}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.commit=function(){var t=this,e=function(){return t._request("merges",{method:"POST",body:{message:"Merging editing branch",head:t.branch,base:t.from}})},n=function(){return t._request("git/refs/heads/"+t.branch,{method:"DELETE"})};return this._enqueue(function(){return e().then(n).then(h)})},e}(_),m=function(){this._observers={"*":[]},this._data={}};m.prototype.observe=function(t,e){var n=this;return this._observers[t]=(this._observers[t]||[]).concat(e),{unobserve:function(){n._observers[t]=n._observers[t].filter(function(t){return t!==e})}}},m.prototype.set=function(t,e){var r=!n(this._data[t],e);if(this._data[t]=e,r){var o=this._observers[t],i=this._observers["*"];if(o)for(var s=0,a=o.length;s<a;s++)o[s](e,t);for(var u=0,c=i.length;u<c;u++)i[u](e,t)}},m.prototype.get=function(t){return this._data[t]},m.prototype.has=function(t){return t in this._data},m.prototype.entries=function(){var t=this,e=[];for(var n in t._data)e.push([n,t.get(n)]);return e},m.prototype.toObject=function(){return d({},this._data)};var y=function(){this._content=new m,this._states=new m,this._cache=new m,this.version="3.0.1"};return y.prototype.init=function(t){var e=this;void 0===t&&(t={});var r=t.repo,o=t.auth,i=t.public;void 0===i&&(i="");var s=t.branch;void 0===s&&(s="master");var a=t.source;void 0===a&&(a="https://raw.githubusercontent.com/"+r+"/"+s+"/"+i);var u=t._indexes;void 0===u&&(u=[]),a="/"===a.charAt(a.length-1)?a.slice(0,-1):a;var c="/_content/data",h="/_content/uploads";this._source=new b({data:a+c,uploads:a+h,cacheBusting:/\/\/raw\.githubusercontent\.com/.test(a)}),this._auth=o,this._storage=new _({data:i?"/"+i+c:c,uploads:i?"/"+i+h:h,repo:r,branch:s});var f=function(t,r){var o=e._states.get("buffer"),i=e._cache.get(r),s=!n(i&&i.data,t&&t.data);o[r]={modified:s},e._states.set("buffer",o)};this._content.observe("*",f),this._cache.observe("*",f),this.observeState("token",function(t){t?window.localStorage.setItem("sm.oss.token",t):window.localStorage.removeItem("sm.oss.token"),e._states.set("authenticated",!!t),e._storage.credentials={token:t}}),this._states.set("config",{repo:r,branch:s,public:i,source:a}),this._states.set("token",window.localStorage.getItem("sm.oss.token")||null),this._states.set("editable",!1),this._states.set("buffer",{}),u.forEach(function(t){var n=function(t,e){return new Date(e.createdAt)-new Date(t.createdAt)},r=t.name,o=t.filter;e.get("/_index/"+r).then(function(t){var i=new m;(t&&t.data||[]).forEach(function(t){return i.set(t.path,t)}),e._content.observe("*",function(t,e){o(t)?i.set(e,t):i.has(e)&&i.set(e,null)}),i.observe("*",function(){var t=i.entries().map(function(t){return t[1]}).filter(function(t){return!!t}).sort(n);e._content.set("/_index/"+r,{data:t})})})})},y.prototype._fetch=function(t){var e=this;return this._cache.has(t)?Promise.resolve(this._cache.get(t)):this._source.get(t).then(function(n){return e._cache.set(t,n),n})},y.prototype.getState=function(t){return t?this._states.get(t):this._states.toObject()},y.prototype.editable=function(t){this._states.set("editable",t)},y.prototype.observeState=function(t,e){return this._states.observe(t,e)},y.prototype.get=function(t){var e=this;return this._content.has(t)?Promise.resolve(this._content.get(t)):this._fetch(t).then(function(n){return e._content.set(t,n),n})},y.prototype.set=function(t,e){var o=this;return Promise.resolve().then(function(){return i(t),s(e),o.get(t)}).then(function(i){var s=function(t){return e&&i&&n(e[t],i[t])};if(e===i||s("data")&&s("type"))return i;if(null===e)return Promise.resolve(o._content.set(t,e));var a=d({type:null},i||{},e,{path:t});return i||(a.createdAt=(new Date).toISOString()),a.updatedAt=(new Date).toISOString(),o._content.set(t,r(a)),a})},y.prototype.remove=function(t){return i(t),this.set(t,null)},y.prototype.observe=function(t,e){return i(t),this._content.observe(t,e)},y.prototype.login=function(){var t=this;return this._auth.authenticate().then(function(e){var n=e.token;t._states.set("token",n)})},y.prototype.logout=function(){this._states.set("token",null)},y.prototype.save=function(t){var e=this,n=this.getState("buffer"),r=(t?[[t,this._content.get(t)]]:this._content.entries()).filter(u(n)),o=!!r.length;return Promise.resolve().then(function(){if(t&&i(t),o)return e._storage.startTransaction()}).then(function(t){if(o)return r.forEach(function(e){var n=e[0],r=e[1];null===r?t.remove(n):t.set(n,r)}),t.commit()}).then(function(){r.forEach(function(t){var n=t[0],r=t[1];e._content.set(n,r),e._cache.set(n,r)})})},y.prototype._loadDB=function(){var t=this;return this._storage.all().then(function(e){return Promise.all(e.map(function(e){return t.get(e)}))})},new y});
